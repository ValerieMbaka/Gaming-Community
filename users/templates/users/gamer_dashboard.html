{% extends 'core/base_minimal.html' %}
{% load static %}

{% block title %} User Dashboard | GameHub {% endblock %}

{% block dashboard_css %}
    <link rel="stylesheet" href="{% static 'users/css/dashboard.css' %}">
    <link rel="stylesheet" href="{% static 'users/css/profile_completion.css' %}">
	<link rel="stylesheet" href="{% static 'users/css/modal.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.13.3/css/selectize.default.min.css">
{% endblock %}

{% block content %}
<div id="profileCompletionModal" class="modal {% if not user.is_profile_complete %}show mandatory{% endif %}">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Complete Your Profile</h3>
            <p>Please fill in your profile details to continue using GameHub</p>
            <button class="modal-close" onclick="closeProfileModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            {% include 'users/profile_completion.html' %}
        </div>
    </div>
</div>

<!-- Profile Header Section -->
<section class="profile-header-wrapper">
    <div class="profile-header-grid">
        <!-- Left Column: Profile Avatar -->
        <div class="profile-avatar-column">
            <div class="profile-avatar-container">
            <img src="{% if user.profile_picture %}{{ user.profile_picture.url }}{% else %}{% static 'core/images/player.jpeg' %}{% endif %}"
                 alt="Profile Avatar" class="profile-main-avatar">
            <input type="file" id="avatarUpload" accept="image/*" style="display: none;">
        </div>
            <div class="profile-info">
            <div class="profile-name-wrapper">
                <h1 class="profile-name">{{ display_username }}</h1>
                <span class="verified-badge" title="Verified Account">
                    <i class="fas fa-check-circle"></i>
                </span>
            </div>
            <p class="profile-title">{% if user.bio and user.bio != "Bio" and user.bio != "" %}{{ user.bio }}{% else %}Gaming Enthusiast{% endif %}</p>
            <div class="profile-location">
                <i class="fas fa-map-marker-alt"></i>
                <span>{% if user.location and user.location != "" %}{{ user.location }}{% else %}Location not set{% endif %}</span>
            </div>
            </div>
        </div>

        <!-- Right Column: Cover Image + Stats -->
        <div class="profile-content-column">
            <!-- Top Section: Cover Image -->
            <div class="profile-cover-section">
                <div class="profile-cover-container">
                    <img src="{% static 'core/images/gameroom1.jpeg' %}" alt="Profile Cover" class="profile-cover-image">
        <div class="profile-actions-container">
            <button class="btn btn-streaming">
                <i class="fas fa-gamepad me-2"></i> Start Streaming
            </button>
            <button class="btn btn-icon btn-action" title="More options">
                <i class="fas fa-ellipsis-h"></i>
            </button>
                    </div>
                </div>
            </div>

            <!-- Bottom Section: Performance Stats -->
            <div class="performance-stats-section">
                <h3 class="section-title">Performance Stats</h3>
                <div class="stats-grid-horizontal">
                    <!-- Win Rate with Progress -->
                    <div class="stat-item-horizontal win-rate">
                        <div class="stat-content">
                            <div class="stat-icon">
                                <i class="fas fa-trophy"></i>
                            </div>
                            <div class="stat-text">
                                <div class="stat-value">87% <span class="stat-trend up">+2%</span></div>
                                <div class="stat-label">Win Rate</div>
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 87%"></div>
                        </div>
                    </div>

                    <!-- Competitions -->
                    <div class="stat-item-horizontal competitions">
                        <div class="stat-content">
                            <div class="stat-icon">
                                <i class="fas fa-calendar-alt"></i>
                            </div>
                            <div class="stat-text">
                                <div class="stat-value">24</div>
                                <div class="stat-label">Competitions</div>
                            </div>
                        </div>
                    </div>

                    <!-- Play Time -->
                    <div class="stat-item-horizontal play-time">
                        <div class="stat-content">
                            <div class="stat-icon">
                                <i class="fas fa-hourglass-half"></i>
                            </div>
                            <div class="stat-text">
                                <div class="stat-value">24h</div>
                                <div class="stat-label">Play Time</div>
                            </div>
                        </div>
                    </div>

                    <!-- Communities -->
                    <div class="stat-item-horizontal communities">
                        <div class="stat-content">
                            <div class="stat-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stat-text">
                                <div class="stat-value">{{ user_stats.platforms_count }}</div>
                                <div class="stat-label">Platforms</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Content Tabs -->
<nav class="profile-tabs-container">
    <div class="profile-tabs-inner">
        <button class="profile-tab active" data-tab="overview">
            <i class="fas fa-tachometer-alt"></i>
            <span>Overview</span>
        </button>
        <button class="profile-tab" data-tab="games">
            <i class="fas fa-gamepad"></i>
            <span>My Games <span class="badge">{{ user_stats.games_count }}</span></span>
        </button>
        <button class="profile-tab" data-tab="competitions">
            <i class="fas fa-trophy"></i>
            <span>Competitions <span class="badge">2</span></span>
        </button>
        <button class="profile-tab" data-tab="performance">
            <i class="fas fa-chart-line"></i>
            <span>Performance</span>
        </button>
    </div>
</nav>

<!-- Tab Content -->
<div class="profile-tab-content active" id="overview">
    <!-- Quick Actions -->
    <section class="profile-card">
        <div class="card-header">
            <h2>
                <i class="fas fa-bolt"></i>
                <span>Quick Actions</span>
            </h2>
        </div>
        <div class="card-body">
            <div class="action-buttons">
                <button class="action-btn" data-tooltip="Join a competition">
                    <div class="action-icon">
                        <i class="fas fa-trophy"></i>
                    </div>
                    <span>Join Competition</span>
                </button>
                <button class="action-btn" data-tooltip="Create a new team">
                    <div class="action-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <span>Create Group</span>
                </button>
                <button class="action-btn" data-tooltip="Start a live stream">
                    <div class="action-icon">
                        <i class="fas fa-stream"></i>
                    </div>
                    <span>Go Live</span>
                </button>
                <button class="action-btn" data-tooltip="View activity feed">
                    <div class="action-icon">
                        <i class="fas fa-newspaper"></i>
                    </div>
                    <span>View Feeds</span>
                </button>
            </div>
        </div>
    </section>

    <!-- Two Column Layout: Featured Games + Recent Achievements -->
    <div class="dashboard-two-column">
        <!-- Left Column: Featured Games -->
        <div class="featured-games-column">
            <section class="profile-card">
                <div class="card-header">
                    <h2>
                        <i class="fas fa-crown"></i>
                        <span>Featured Games</span>
                    </h2>
                    <a href="#" class="view-all-link">View All</a>
                </div>
                <div class="card-body">
                    {% if featured_game and featured_game.name %}
                    <div class="featured-game-card">
                        <div class="game-banner-container">
                            <img src="{% static 'core/images/cod.jpeg' %}" alt="{{ featured_game.name }}" class="game-banner">
                        </div>
                        <div class="game-info-container">
                            <h3 class="game-title">{{ featured_game.name }}</h3>
                            <div class="game-stats-grid">
                                <div class="game-stat">
                                    <span class="stat-value">{{ featured_game.hours_played|floatformat:0 }}</span>
                                    <span class="stat-label">Hours Played</span>
                                </div>
                                <div class="game-stat">
                                    <span class="stat-value">{{ featured_game.win_rate }}%</span>
                                    <span class="stat-label">Win Rate</span>
                                </div>
                                <div class="game-stat">
                                    <span class="stat-value">{{ featured_game.competitions }}</span>
                                    <span class="stat-label">Competitions</span>
                                </div>
                            </div>
                            <div class="game-rank-card">
                                <div class="rank-icon-container">
                                    <img src="{% static 'core/images/faze.jpeg' %}" alt="{{ featured_game.rank }} Rank" class="rank-icon">
                                </div>
                                <div class="rank-info">
                                    <span class="rank-name">{{ featured_game.rank }}</span>
                                    <span class="rank-position">Top Player</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="empty-state">
                        <i class="fas fa-gamepad"></i>
                        <h3>No games added yet</h3>
                        <p>Add your favorite games to see them featured here</p>
                        <button class="btn btn-primary mt-3" onclick="document.getElementById('profileCompletionModal').classList.add('show')">Add Games</button>
                    </div>
                    {% endif %}
                </div>
            </section>
        </div>

        <!-- Right Column: Recent Achievements -->
        <div class="recent-achievements-column">
            <section class="profile-card">
                <div class="card-header">
                    <h2>
                        <i class="fas fa-trophy"></i>
                        <span>Recent Achievements</span>
                    </h2>
                    <a href="#" class="view-all-link">View All</a>
                </div>
                <div class="card-body">
                    <div class="achievements-list">
                        <div class="achievement-item">
                            <div class="achievement-badge gold">
                                <i class="fas fa-user-check"></i>
                            </div>
                            <div class="achievement-details">
                                <h4 class="achievement-title">Profile Completion</h4>
                                <p class="achievement-date">{{ user_stats.join_date }}</p>
                                <div class="achievement-game">
                                    <img src="{% static 'core/images/player.jpeg' %}" alt="Profile">
                                </div>
                            </div>
                        </div>
                        {% if user.games and user.games|length > 0 %}
                        <div class="achievement-item">
                            <div class="achievement-badge silver">
                                <i class="fas fa-gamepad"></i>
                            </div>
                            <div class="achievement-details">
                                <h4 class="achievement-title">Game Collector</h4>
                                <p class="achievement-date">{{ user_stats.join_date }}</p>
                                <div class="achievement-game">
                                    <img src="{% static 'core/images/gamepad.jpeg' %}" alt="Games">
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% if user.platforms and user.platforms|length > 0 %}
                        <div class="achievement-item">
                            <div class="achievement-badge bronze">
                                <i class="fas fa-desktop"></i>
                            </div>
                            <div class="achievement-details">
                                <h4 class="achievement-title">Multi-Platform Gamer</h4>
                                <p class="achievement-date">{{ user_stats.join_date }}</p>
                                <div class="achievement-game">
                                    <img src="{% static 'core/images/ps5.jpeg' %}" alt="Platforms">
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- Recent Activities Section -->
    <section class="profile-card">
        <div class="card-header">
            <h2>
                <i class="fas fa-history"></i>
                <span>Recent Activities</span>
            </h2>
            <a href="#" class="view-all-link">View All</a>
        </div>
        <div class="card-body">
            <div class="activity-feed">
                <div class="activity-item">
                    <div class="activity-icon">
                        <img src="{% static 'core/images/player.jpeg' %}" alt="Profile">
                    </div>
                    <div class="activity-content">
                        <h3 class="activity-title">Profile Updated</h3>
                        <p class="activity-meta">{{ user_stats.join_date }}</p>
                        <p class="activity-description">{% if user.games and user.games|length > 0 %}Added {{ user.games|length }} game{{ user.games|length|pluralize }} to your profile{% else %}Started your gaming journey{% endif %}</p>
                        <div class="activity-stats">
                            <span class="activity-stat">
                                <i class="fas fa-gamepad"></i>
                                <span>{% if user.games and user.games|length > 0 %}{{ user.games|length }} Game{{ user.games|length|pluralize }}{% else %}No Games{% endif %}</span>
                            </span>
                            <span class="activity-stat">
                                <i class="fas fa-desktop"></i>
                                <span>{% if user.platforms and user.platforms|length > 0 %}{{ user.platforms|length }} Platform{{ user.platforms|length|pluralize }}{% else %}No Platforms{% endif %}</span>
                            </span>
                        </div>
                        <div class="activity-actions">
                            <button class="btn-like"><i class="far fa-heart"></i> 0</button>
                            <button class="btn-comment"><i class="far fa-comment"></i> 0</button>
                        </div>
                    </div>
                </div>

                {% if user.games and user.games|length > 0 %}
                <div class="activity-item">
                    <div class="activity-icon">
                        <img src="" alt="Games" data-game="{% for game in user.games %}{{ game }}{% if not forloop.last %}, {% endif %}{% endfor %}" class="activity-game-image">
                    </div>
                    <div class="activity-content">
                        <h3 class="activity-title">Games Added to Profile</h3>
                        <p class="activity-meta">{{ user_stats.join_date }}</p>
                        <p class="activity-description">"{% for game in user.games %}{{ game }}{% if not forloop.last %}, {% endif %}{% endfor %}"</p>
                        <div class="activity-stats">
                            <span class="activity-stat">
                                <i class="fas fa-check-circle"></i>
                                <span>Profile Complete</span>
                            </span>
                            <span class="activity-stat">
                                <i class="fas fa-star"></i>
                                <span>Ready to Play</span>
                            </span>
                        </div>
                        <div class="activity-actions">
                            <button class="btn-like"><i class="far fa-heart"></i> 0</button>
                            <button class="btn-comment"><i class="far fa-comment"></i> 0</button>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </section>
</div>

<!-- Games Tab Content -->
<div class="profile-tab-content" id="games">
    <section class="profile-card">
        <div class="card-header">
            <h2>
                <i class="fas fa-gamepad"></i>
                <span>My Games</span>
            </h2>
        </div>
        <div class="card-body">
            {% if user.games and user.games|length > 0 and user.games.0 %}
            <div class="game-carousel">
                {% for game in user.games %}
                <div class="game-card">
                    <div class="game-status">Active</div>
                    <div class="platform-badges">
                        <span class="platform-badge">PC</span>
                        <span class="platform-badge">PS5</span>
                    </div>
                    <img src="" alt="{{ game }}" data-game="{{ game }}" class="game-image">
                    <div class="game-info">
                        <h4>{{ game }}</h4>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <i class="fas fa-gamepad"></i>
                <h3>No games added yet</h3>
                <p>Add your favorite games to see them here</p>
                <button class="btn btn-primary mt-3" onclick="document.getElementById('profileCompletionModal').classList.add('show')">Add Games</button>
            </div>
            {% endif %}
        </div>
    </section>
</div>

<!-- Competitions Tab Content -->
<div class="profile-tab-content" id="competitions">
    <section class="profile-card">
        <div class="card-header">
            <h2>
                <i class="fas fa-trophy"></i>
                <span>My Competitions</span>
            </h2>
        </div>
        <div class="card-body">
            <div class="competition-grid">
                <div class="competition-card">
                    <div class="competition-card-header">
                        <img src="{% static 'core/images/cod.jpeg' %}"
                             class="competition-card-image" alt="Valorant">
                        <div class="competition-status active">Active</div>
                    </div>
                    <div class="competition-card-body">
                        <h4 class="competition-title">Valorant Weekly</h4>
                        <p class="competition-meta">
                            <i class="fas fa-calendar-alt"></i> Tomorrow, 8:00 PM
                        </p>
                        <div class="competition-prize">
                            <i class="fas fa-gem"></i> $1,000 Prize Pool
                        </div>
                        <div class="countdown-timer">
                            <div class="countdown-segment">
                                <span class="countdown-value">1</span>
                                <span class="countdown-label">Day</span>
                            </div>
                            <div class="countdown-segment">
                                <span class="countdown-value">8</span>
                                <span class="countdown-label">Hours</span>
                            </div>
                        </div>
                        <button class="competition-btn primary">
                            Register Now
                        </button>
                    </div>
                </div>
                
                <div class="competition-card">
                    <div class="competition-card-header">
                        <img src="{% static 'core/images/fc.jpeg' %}"
                             class="competition-card-image" alt="FIFA">
                        <div class="competition-status upcoming">Upcoming</div>
                    </div>
                    <div class="competition-card-body">
                        <h4 class="competition-title">FIFA Weekend Cup</h4>
                        <p class="competition-meta">
                            <i class="fas fa-calendar-alt"></i> Saturday, 3:00 PM
                        </p>
                        <div class="competition-prize">
                            <i class="fas fa-gem"></i> $500 Prize Pool
                        </div>
                        <div class="countdown-timer">
                            <div class="countdown-segment">
                                <span class="countdown-value">3</span>
                                <span class="countdown-label">Days</span>
                            </div>
                            <div class="countdown-segment">
                                <span class="countdown-value">15</span>
                                <span class="countdown-label">Hours</span>
                            </div>
                        </div>
                        <button class="competition-btn secondary">
                            View Details
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>

<!-- Performance Tab Content -->
<div class="profile-tab-content" id="performance">
    <section class="profile-card">
        <div class="card-header">
            <h2>
                <i class="fas fa-chart-line"></i>
                <span>Performance Metrics</span>
            </h2>
        </div>
        <div class="card-body">
            <div class="empty-state">
                <i class="fas fa-chart-pie"></i>
                <h3>No performance data yet</h3>
                <p>Play some games to see your stats</p>
                <button class="btn btn-primary mt-3">Join a Competition</button>
            </div>
        </div>
    </section>
</div>

{% endblock %}

{% block dashboard_js %}
    <script src="{% static 'users/js/modal.js' %}"></script>
    <script src="{% static 'users/js/profile_completion.js' %}"></script>
    <script src="{% static 'users/js/dashboard.js' %}"></script>
    <script>
        function closeProfileModal() {
            const modal = document.getElementById('profileCompletionModal');
            if (modal && !modal.classList.contains('mandatory')) {
                modal.classList.remove('show');
            }
        }
        
        // Prevent closing mandatory modal
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('profileCompletionModal');
            if (modal && modal.classList.contains('mandatory')) {
                // Prevent closing by clicking outside
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        e.stopPropagation();
                    }
                });
                
                // Prevent closing with ESC key
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape' && modal.classList.contains('mandatory')) {
                        e.preventDefault();
                    }
                });
            }
        });
    </script>
{% endblock %}